package main

import (
	"flag"
	"fmt"
	"log"
	"net"
	"net/http"
	"strings"
	"sync"
	"time"
	"math/rand"

	matrix "github.com/arvchahal/Limitly/server/matrix"
	server "github.com/arvchahal/Limitly/server/rate" // Import your custom rate-limiting package
)

// Client represents a client with a rate limiter
type Client struct {
	limiter  server.RateLimiter
	lastSeen time.Time
}

var (
	clients   = make(map[string]*Client)
	clientsMu sync.Mutex

	// Rate limit parameters (modifiable via flags)
	rateLimitAlgorithm = "token_bucket" // Default algorithm
	requestsPerSecond  = 10
	burstLimit         = 5
	windowSize         = time.Second

	// Counters for requests
	acceptedCount  int
	deniedCount    int
	non200Count    int
	requestCountMu sync.Mutex
)

// Example function to process the request
func customFunction(r *http.Request) {
	matrices := [][][]float64{
		{
			{3.276462632418619, 1.433964084262537, 2.3477203234320934, 2.8214753709320357, 2.7164738691599792, 2.3073256579309436, 2.3492900143563715, 3.243974489073463, 2.7040072041263286, 3.376068657548277},
			{1.433964084262537, 0.9058452171735455, 1.0949286330672248, 1.6704921694790313, 1.2765987950493536, 0.9446303517987942, 1.0702034490963728, 1.5782666939488905, 1.1909104424155614, 1.4891869727773788},
			{2.3477203234320934, 1.0949286330672248, 2.3682020652172193, 2.401895228658193, 2.149750911728735, 1.9115890488990521, 1.9032315498338412, 2.494611637868243, 2.2578583250370508, 3.076559326624844},
			{2.8214753709320357, 1.6704921694790313, 2.401895228658193, 4.656500433454244, 3.4627661149694893, 2.947108735039108, 2.3873619037723546, 3.7700595658992087, 2.958806071931527, 3.3736310675683474},
			{2.7164738691599792, 1.2765987950493536, 2.149750911728735, 3.4627661149694893, 3.499393633203912, 2.29315296026262, 2.18983201778001, 3.392554504344883, 2.975149120009088, 3.0784766532012053},
			{2.3073256579309436, 0.9446303517987942, 1.9115890488990521, 2.947108735039108, 2.29315296026262, 3.15434804843654, 1.8744034597416244, 2.576383128617703, 1.9736485100400292, 2.6492469857830354},
			{2.3492900143563715, 1.0702034490963728, 1.9032315498338412, 2.3873619037723546, 2.18983201778001, 1.8744034597416244, 2.223812614354681, 2.7649736336460644, 2.1347369457159284, 2.4940820539532687},
			{3.243974489073463, 1.5782666939488905, 2.494611637868243, 3.7700595658992087, 3.392554504344883, 2.576383128617703, 2.7649736336460644, 4.098739290173831, 3.204367443102286, 3.5493474532382505},
			{2.7040072041263286, 1.1909104424155614, 2.2578583250370508, 2.958806071931527, 2.975149120009088, 1.9736485100400292, 2.1347369457159284, 3.204367443102286, 2.919670379487631, 3.201077880123607},
			{3.376068657548277, 1.4891869727773788, 3.076559326624844, 3.3736310675683474, 3.0784766532012053, 2.6492469857830354, 2.4940820539532687, 3.5493474532382505, 3.201077880123607, 4.382414395955858},
		},
		{
			{4.225006636502511, 1.9727836451824374, 2.184509798501753, 3.3612741598910976, 3.6684803244693533, 2.8404946059294933, 3.0368401321039946, 3.9345426789377815, 3.61480481659955, 3.896643128394681},
			{1.9727836451824374, 1.9673309993793298, 1.548285253351185, 2.154505717350933, 2.1922673419855916, 1.4406515526495136, 1.6347612210497984, 2.234116861769457, 1.6518463981795322, 1.9264300866768562},
			{2.184509798501753, 1.548285253351185, 1.816769376041298, 2.3237724090782104, 2.3108568058584162, 1.6729900630498273, 1.7351019749962968, 2.5370374507054687, 2.1681966199203457, 2.4363436568652648},
			{3.3612741598910976, 2.154505717350933, 2.3237724090782104, 4.125147571528289, 3.5908705007939066, 3.2021624231662966, 2.640625247873, 3.8934666723067792, 3.7637962231128093, 3.8831220511534124},
			{3.6684803244693533, 2.1922673419855916, 2.3108568058584162, 3.5908705007939066, 4.53035248711851, 2.9579688893601452, 3.3100929155537395, 4.19679152364804, 3.823741917111372, 3.852180315994576},
			{2.8404946059294933, 1.4406515526495136, 1.6729900630498273, 3.2021624231662966, 2.9579688893601452, 3.005929581878917, 1.8973666119953472, 2.7638299519766263, 3.112651863110996, 3.1199930941403173},
			{3.0368401321039946, 1.6347612210497984, 1.7351019749962968, 2.640625247873, 3.3100929155537395, 1.8973666119953472, 3.2155670682005986, 3.477088370116935, 3.0677627499892735, 3.0867820856697907},
			{3.9345426789377815, 2.234116861769457, 2.5370374507054687, 3.8934666723067792, 4.19679152364804, 2.7638299519766263, 3.477088370116935, 4.9378296666751105, 4.205715047327023, 4.3099661111840515},
			{3.61480481659955, 1.6518463981795322, 2.1681966199203457, 3.7637962231128093, 3.823741917111372, 3.112651863110996, 3.0677627499892735, 4.205715047327023, 4.344685783398211, 3.891444599832763},
			{3.896643128394681, 1.9264300866768562, 2.4363436568652648, 3.8831220511534124, 3.852180315994576, 3.1199930941403173, 3.0867820856697907, 4.3099661111840515, 3.891444599832763, 4.59418081146272},
		},
		[][]float64{
			{3.3477972457043847, 1.2502988963093344, 2.6599993337773156, 3.5177834459234902, 2.476448518830091, 2.3089681909643742, 2.5531465701989013, 3.046870203601118, 1.9221114196751983, 2.8741991810526026},
			{1.2502988963093344, 1.6919938205330491, 2.4422031206195753, 2.2782046499527415, 1.6879648785597943, 1.769379547497411, 1.8319526129852945, 2.248250794850677, 1.777852543358577, 1.9953974099570737},
			{2.6599993337773156, 2.4422031206195753, 4.324259271812515, 4.002189540150033, 2.883048025475696, 2.610982814253462, 3.2554800982118746, 3.920428149686153, 2.902005610393809, 3.4503331370369543},
			{3.5177834459234902, 2.2782046499527415, 4.002189540150033, 5.798567812809074, 3.391691345979304, 3.1229738473168887, 4.471010950927599, 4.1385984117063845, 3.6552550326361946, 3.6811145204682103},
			{2.476448518830091, 1.6879648785597943, 2.883048025475696, 3.391691345979304, 3.176313219490407, 2.7272874322779495, 2.8671723380421597, 3.07252381515106, 2.542964257246757, 2.743109510612999},
			{2.3089681909643742, 1.769379547497411, 2.610982814253462, 3.1229738473168887, 2.7272874322779495, 3.0965979362426523, 2.386849005275795, 2.749842839906078, 2.457288890201752, 2.7776925982501823},
			{2.5531465701989013, 1.8319526129852945, 3.2554800982118746, 4.471010950927599, 2.8671723380421597, 2.386849005275795, 4.085989015007851, 2.994346017032307, 3.1943073475874746, 2.793759353595847},
			{3.046870203601118, 2.248250794850677, 3.920428149686153, 4.1385984117063845, 3.07252381515106, 2.749842839906078, 2.994346017032307, 4.273210075100955, 2.5546941755795665, 3.6223859991748757},
			{1.9221114196751983, 1.777852543358577, 2.902005610393809, 3.6552550326361946, 2.542964257246757, 2.457288890201752, 3.1943073475874746, 2.5546941755795665, 3.165243459632307, 1.9982942355600803},
			{2.8741991810526026, 1.9953974099570737, 3.4503331370369543, 3.6811145204682103, 2.743109510612999, 2.7776925982501823, 2.793759353595847, 3.6223859991748757, 1.9982942355600803, 4.130454188469722},
		},
		[][]float64{
			{3.6834881123465086, 2.889560824191549, 3.59316975584135, 3.096329409537225, 3.344419819116631, 1.5228386157805416, 3.9265611799284947, 2.36017821421486, 3.3516195036819196, 2.2096275695771497},
			{2.889560824191549, 2.92654370519173, 2.7023469487333553, 2.830192400820379, 2.71629827647169, 1.326494841535338, 3.125330984661298, 2.1695164186314155, 2.289719601525308, 1.392362965373248},
			{3.59316975584135, 2.7023469487333553, 4.836313765766288, 2.4281558870403543, 3.6346514203307216, 1.6001595661087713, 4.474001128027473, 2.9098451052569434, 3.9808389344167603, 2.94708835593748},
			{3.096329409537225, 2.830192400820379, 2.4281558870403543, 3.4171290650581287, 2.7521412616375653, 1.294597901400874, 3.321095341318748, 1.9136894573246013, 2.4147091778622354, 1.677428766788785},
			{3.344419819116631, 2.71629827647169, 3.6346514203307216, 2.7521412616375653, 5.2819983945534625, 2.575647915674406, 4.410493038497215, 3.053156358826, 3.768504365400243, 2.8956593455753183},
			{1.5228386157805416, 1.326494841535338, 1.6001595661087713, 1.294597901400874, 2.575647915674406, 1.7132183126384537, 2.5438694428743718, 1.2403980187040544, 1.8124448347771909, 1.3420017606453354},
			{3.9265611799284947, 3.125330984661298, 4.474001128027473, 3.321095341318748, 4.410493038497215, 2.5438694428743718, 5.849645546375663, 2.9374095726956506, 4.40670325498103, 3.3653609138263807},
			{2.36017821421486, 2.1695164186314155, 2.9098451052569434, 1.9136894573246013, 3.053156358826, 1.2403980187040544, 2.9374095726956506, 2.492092103664994, 2.53616999114142, 1.8674872540095868},
			{3.3516195036819196, 2.289719601525308, 3.9808389344167603, 2.4147091778622354, 3.768504365400243, 1.8124448347771909, 4.40670325498103, 2.53616999114142, 3.9972170848866773, 2.8247127425627783},
			{2.2096275695771497, 1.392362965373248, 2.94708835593748, 1.677428766788785, 2.8956593455753183, 1.3420017606453354, 3.3653609138263807, 1.8674872540095868, 2.8247127425627783, 2.6852577331018472},
		},
		[][]float64{
			{4.499500683228404, 2.5344086324432045, 4.1006110793208626, 1.875627673696679, 3.073391124721531, 4.150586097086418, 3.0063347425356195, 4.036221569727415, 2.9871375611567883, 3.526656028397421},
			{2.5344086324432045, 2.464647279006812, 2.6320365774641634, 0.9391256246875573, 2.047719397232468, 2.5482694682498868, 2.183161712001575, 2.702678608510717, 1.9802359053282639, 1.9247897657567221},
			{4.1006110793208626, 2.6320365774641634, 4.2360701705359505, 1.7161272005567947, 3.2050732166742932, 3.7661998686797573, 3.079414219260515, 4.001000263348472, 2.898988772512471, 3.1807865250839575},
			{1.875627673696679, 0.9391256246875573, 1.7161272005567947, 1.296202712808136, 1.4510680043162274, 1.844321047545525, 1.0782728420770977, 1.8014316125483594, 0.8689497705592814, 1.847402963886769},
			{3.073391124721531, 2.047719397232468, 3.2050732166742932, 1.4510680043162274, 2.9794647805846757, 3.4230749477056426, 2.5819782119055477, 3.318191105586601, 2.0864823252625264, 2.6287737455171016},
			{4.150586097086418, 2.5482694682498868, 3.7661998686797573, 1.844321047545525, 3.4230749477056426, 5.103872777671488, 3.114460659044825, 4.0182996293981805, 3.3015925721439765, 3.5645685390722317},
			{3.0063347425356195, 2.183161712001575, 3.079414219260515, 1.0782728420770977, 2.5819782119055477, 3.114460659044825, 3.1463907509904576, 2.8626782395704358, 2.409360494733817, 2.202985854308031},
			{4.036221569727415, 2.702678608510717, 4.001000263348472, 1.8014316125483594, 3.318191105586601, 4.0182996293981805, 2.8626782395704358, 4.761603966186907, 2.4874133374683263, 3.565814856572066},
			{2.9871375611567883, 1.9802359053282639, 2.898988772512471, 0.8689497705592814, 2.0864823252625264, 3.3015925721439765, 2.409360494733817, 2.4874133374683263, 3.604918287613458, 2.4786022003780213},
			{3.526656028397421, 1.9247897657567221, 3.1807865250839575, 1.847402963886769, 2.6287737455171016, 3.5645685390722317, 2.202985854308031, 3.565814856572066, 2.4786022003780213, 3.6799158871449626},
		},
		[][]float64{
			{3.083463979558772, 1.4282812087485377, 2.669277004085216, 2.1544316238724575, 3.137079229285945, 2.2180260061385857, 1.8847412210078476, 2.9395910201153326, 1.942905469902485, 2.2597284663363633},
			{1.4282812087485377, 2.2926134030436094, 2.3638390361185504, 2.036570454412061, 2.769613397302297, 1.7658457577342639, 1.1280928834710546, 2.0174062966671515, 1.9073501678774365, 2.25369171727524},
			{2.669277004085216, 2.3638390361185504, 4.393120637976971, 2.4654999727720277, 3.949508568490699, 3.0280738978667565, 1.857662892965249, 3.742632347945122, 2.6869381197117073, 3.7203485037453614},
			{2.1544316238724575, 2.036570454412061, 2.4654999727720277, 2.540870408533157, 3.17899031943232, 2.548734946247275, 1.5044559959896044, 2.4719402196982676, 1.989849476194839, 2.23687904400988},
			{3.137079229285945, 2.769613397302297, 3.949508568490699, 3.17899031943232, 4.909124276028696, 3.5744349390866508, 2.4650800468793963, 3.785803865357192, 3.2336518376443513, 4.009812169910317},
			{2.2180260061385857, 1.7658457577342639, 3.0280738978667565, 2.548734946247275, 3.5744349390866508, 3.6022755230023393, 2.143927172864459, 3.041216577653544, 2.387715438111934, 2.9739940553916915},
			{1.8847412210078476, 1.1280928834710546, 1.857662892965249, 1.5044559959896044, 2.4650800468793963, 2.143927172864459, 2.342210990432737, 2.3266018547416474, 1.9196444196829325, 2.5461932370254683},
			{2.9395910201153326, 2.0174062966671515, 3.742632347945122, 2.4719402196982676, 3.785803865357192, 3.041216577653544, 2.3266018547416474, 3.7798871309694126, 2.4958390064075613, 3.3054081393380765},
			{1.942905469902485, 1.9073501678774365, 2.6869381197117073, 1.989849476194839, 3.2336518376443513, 2.387715438111934, 1.9196444196829325, 2.4958390064075613, 2.5126325685280566, 3.138176255837926},
			{2.2597284663363633, 2.25369171727524, 3.7203485037453614, 2.23687904400988, 4.009812169910317, 2.9739940553916915, 2.5461932370254683, 3.3054081393380765, 3.138176255837926, 4.673414953017751},
		},
		[][]float64{
			{4.097602799079835, 3.4980267182772997, 3.9556870492038576, 3.48605243149869, 2.981621071248437, 2.346997886547391, 3.226274021061978, 3.1898793476124445, 1.8421298309567031, 3.105200120110174},
			{3.4980267182772997, 3.759023405475049, 3.659989440542532, 3.064108107246742, 2.140939584637367, 2.438578642574908, 3.0821019611344482, 2.7211507547263976, 1.3568865812937088, 2.8351386495253386},
			{3.9556870492038576, 3.659989440542532, 4.525135678906301, 3.5444729042493237, 3.029426149575695, 2.3085265390839615, 3.2432533678755404, 3.776410235472008, 2.5262225704382155, 3.577412996211057},
			{3.48605243149869, 3.064108107246742, 3.5444729042493237, 4.015679913994847, 2.3702835066949928, 1.835476311673905, 3.541684849339354, 3.088607535368948, 2.114100027429647, 3.3209499787349985},
			{2.981621071248437, 2.140939584637367, 3.029426149575695, 2.3702835066949928, 3.3837520491577853, 1.7670638186299237, 2.1344853722769073, 3.168998948851447, 2.0614111421478496, 2.7132001269313277},
			{2.346997886547391, 2.438578642574908, 2.3085265390839615, 1.835476311673905, 1.7670638186299237, 2.2118792836175043, 2.179888934818406, 1.6228800969813904, 0.7666221971383194, 1.7504390291880978},
			{3.226274021061978, 3.0821019611344482, 3.2432533678755404, 3.541684849339354, 2.1344853722769073, 2.179888934818406, 3.65751215440724, 2.7930860293244892, 1.6713895502064555, 3.0619847368695963},
			{3.1898793476124445, 2.7211507547263976, 3.776410235472008, 3.088607535368948, 3.168998948851447, 1.6228800969813904, 2.7930860293244892, 4.328485674535932, 3.0034500847793093, 3.990743602703029},
			{1.8421298309567031, 1.3568865812937088, 2.5262225704382155, 2.114100027429647, 2.0614111421478496, 0.7666221971383194, 1.6713895502064555, 3.0034500847793093, 2.547803759990051, 2.8219587216313187},
			{3.105200120110174, 2.8351386495253386, 3.577412996211057, 3.3209499787349985, 2.7132001269313277, 1.7504390291880978, 3.0619847368695963, 3.990743602703029, 2.8219587216313187, 4.03309541034757},
		},
		[][]float64{
			{2.2271081084546327, 1.7745610490859443, 1.5301326870390388, 2.680461651954302, 1.3615753174778684, 1.9075893487998925, 2.0145088003120963, 1.9297053222790939, 1.5271311708509336, 2.590661906930661},
			{1.7745610490859443, 3.838891562566394, 1.85063136743735, 2.5360759828538946, 1.42976257860167, 2.2848783968937445, 2.2673503943489632, 2.4727038366498704, 2.314433871686071, 3.1417417483503307},
			{1.5301326870390388, 1.85063136743735, 2.3429285761178287, 2.263285322669283, 1.4827105851715385, 2.341614917704094, 1.6723780138728703, 2.19710898846697, 2.2503414865124456, 2.656165072196018},
			{2.680461651954302, 2.5360759828538946, 2.263285322669283, 4.5335541661612355, 2.374851602736329, 2.5732021199568385, 3.245674398120296, 3.487112370797609, 2.414804168043287, 3.3714749375468323},
			{1.3615753174778684, 1.42976257860167, 1.4827105851715385, 2.374851602736329, 1.8702745860410352, 1.1216601052740587, 1.8903433014843987, 2.0147668673567822, 2.0487736691827325, 2.339858889030943},
			{1.9075893487998925, 2.2848783968937445, 2.341614917704094, 2.5732021199568385, 1.1216601052740587, 3.0480456863417325, 1.8309291990611745, 2.4106837765378186, 1.8764460736806337, 2.734983856429439},
			{2.0145088003120963, 2.2673503943489632, 1.6723780138728703, 3.245674398120296, 1.8903433014843987, 1.8309291990611745, 3.0037323619018923, 2.7789133970137088, 2.192968302517394, 2.2658087700954663},
			{1.9297053222790939, 2.4727038366498704, 2.19710898846697, 3.487112370797609, 2.0147668673567822, 2.4106837765378186, 2.7789133970137088, 3.6582010864805565, 2.1688095782891117, 2.586723758478275},
			{1.5271311708509336, 2.314433871686071, 2.2503414865124456, 2.414804168043287, 2.0487736691827325, 1.8764460736806337, 2.192968302517394, 2.1688095782891117, 3.0836536944545454, 3.240175623754165},
			{2.590661906930661, 3.1417417483503307, 2.656165072196018, 3.3714749375468323, 2.339858889030943, 2.734983856429439, 2.2658087700954663, 2.586723758478275, 3.240175623754165, 5.142553202316901},
		},
		[][]float64{
			{4.234336152543039, 3.1343563008295336, 3.298953547641064, 3.1804923547871753, 2.532575791475215, 3.0843686236353984, 2.912163171653769, 3.061460380254997, 2.0917631108322463, 2.763458292726529},
			{3.1343563008295336, 3.3192618722257943, 3.2538872202134197, 3.259823250733167, 2.934837089598636, 2.526469387199761, 3.1933279972718562, 2.847126506290043, 1.9862074898611668, 2.7118315955176624},
			{3.298953547641064, 3.2538872202134197, 3.6729571386280626, 3.417802767461905, 2.8811661003880378, 2.6815743244453727, 3.5425314078692662, 2.8011086519811483, 2.046774880193668, 2.7477223748825206},
			{3.1804923547871753, 3.259823250733167, 3.417802767461905, 3.5926067595691094, 3.328629751211133, 2.6565974360736098, 3.468850027296597, 2.9703200030886423, 2.197863915329069, 3.1987656030762457},
			{2.532575791475215, 2.934837089598636, 2.8811661003880378, 3.328629751211133, 3.8610006956696803, 2.234068978853432, 3.023286029494064, 2.894598923324367, 2.2563790053098316, 3.0396378001956},
			{3.0843686236353984, 2.526469387199761, 2.6815743244453727, 2.6565974360736098, 2.234068978853432, 3.0981148143050476, 2.54053132769368, 2.4298006186269796, 1.783833019185838, 2.7324727402295004},
			{2.912163171653769, 3.1933279972718562, 3.5425314078692662, 3.468850027296597, 3.023286029494064, 2.54053132769368, 4.378311321577727, 2.757131527732671, 2.1358140011871196, 2.8396292582643974},
			{3.061460380254997, 2.847126506290043, 2.8011086519811483, 2.9703200030886423, 2.894598923324367, 2.4298006186269796, 2.757131527732671, 3.040271638678118, 1.7190979116496992, 2.4635423875864655},
			{2.0917631108322463, 1.9862074898611668, 2.046774880193668, 2.197863915329069, 2.2563790053098316, 1.783833019185838, 2.1358140011871196, 1.7190979116496992, 1.729428277339121, 2.068696554239391},
			{2.763458292726529, 2.7118315955176624, 2.7477223748825206, 3.1987656030762457, 3.0396378001956, 2.7324727402295004, 2.8396292582643974, 2.4635423875864655, 2.068696554239391, 3.6581574341973258},
		},
		[][]float64{
			{3.4129632905520895, 3.291277175900689, 2.210178707279343, 2.5515817944790093, 2.719605708545, 2.7775244430790305, 1.4552279287332686, 1.6012774865155877, 2.828833916511593, 2.359115080312448},
			{3.291277175900689, 4.7449549681651195, 3.3183259447148377, 4.008479232525565, 3.0239052761708978, 3.423082873452035, 2.817980410355754, 2.454686498040916, 3.1618498012970098, 3.4358069727024345},
			{2.210178707279343, 3.3183259447148377, 3.0234523187165325, 2.7645767253105986, 2.160551837483079, 2.480745276971677, 2.154327957606546, 1.3600651021695396, 2.3627416083985504, 2.5230161248953187},
			{2.5515817944790093, 4.008479232525565, 2.7645767253105986, 3.875386329169586, 2.3300514764674447, 3.231716787288295, 2.3616885029195007, 1.9062994325778755, 2.6898323158435256, 2.6089342832342677},
			{2.719605708545, 3.0239052761708978, 2.160551837483079, 2.3300514764674447, 3.1291261826411967, 2.436865821124411, 1.750194481685055, 1.5924331375354683, 2.7108230463997987, 2.233787075217923},
			{2.7775244430790305, 3.423082873452035, 2.480745276971677, 3.231716787288295, 2.436865821124411, 3.6742385227125567, 1.4645598115232699, 1.3656710715126053, 2.613215698729272, 2.4746248867351452},
			{1.4552279287332686, 2.817980410355754, 2.154327957606546, 2.3616885029195007, 1.750194481685055, 1.4645598115232699, 2.6121088066773535, 1.5809352949004158, 1.6567426875097673, 2.5652225336008243},
			{1.6012774865155877, 2.454686498040916, 1.3600651021695396, 1.9062994325778755, 1.5924331375354683, 1.3656710715126053, 1.5809352949004158, 1.9500285235982404, 1.4788873467816128, 1.9818200829451422},
			{2.828833916511593, 3.1618498012970098, 2.3627416083985504, 2.6898323158435256, 2.7108230463997987, 2.613215698729272, 1.6567426875097673, 1.4788873467816128, 2.9476054889607948, 1.9764321881760423},
			{2.359115080312448, 3.4358069727024345, 2.5230161248953187, 2.6089342832342677, 2.233787075217923, 2.4746248867351452, 2.5652225336008243, 1.9818200829451422, 1.9764321881760423, 3.6704082517601675},
		},
		[][]float64{
			{3.669770983825433, 3.0829738611175177, 2.292514609687859, 2.7494700354238804, 3.000159984718862, 2.0262774619151, 2.124204054035295, 2.9417900623533937, 2.258080785816607, 3.1073304302880813},
			{3.0829738611175177, 3.622567578407504, 2.491771765812308, 2.5303313297732113, 2.8939753491017712, 2.040085205968717, 2.3760011003763752, 3.0972068974042957, 2.4397376404336, 3.842575678546945},
			{2.292514609687859, 2.491771765812308, 3.389330412711219, 2.2402347389195287, 2.1481765972501075, 1.8721316752521797, 2.6091846444087845, 2.302744287119855, 2.2628272057265346, 3.26665507247731},
			{2.7494700354238804, 2.5303313297732113, 2.2402347389195287, 3.2972576401777878, 2.521687585010396, 1.4098958970498838, 2.312829451810981, 2.6678619686838942, 2.1067167587095983, 2.73717203027656},
			{3.000159984718862, 2.8939753491017712, 2.1481765972501075, 2.521687585010396, 2.8861258538984775, 1.7153455124826624, 1.9161496091450179, 2.536575656014127, 1.9836597394594475, 2.860109030864698},
			{2.0262774619151, 2.040085205968717, 1.8721316752521797, 1.4098958970498838, 1.7153455124826624, 1.8844961218439857, 1.7333484894609306, 1.4632461040278362, 1.6663150066174761, 2.329840233652109},
			{2.124204054035295, 2.3760011003763752, 2.6091846444087845, 2.312829451810981, 1.9161496091450179, 1.7333484894609306, 2.794763470081981, 1.9483314788119819, 2.07544760727833, 2.69459270600386},
			{2.9417900623533937, 3.0972068974042957, 2.302744287119855, 2.6678619686838942, 2.536575656014127, 1.4632461040278362, 1.9483314788119819, 3.456885388014998, 2.3779477329255423, 3.4904230106586307},
			{2.258080785816607, 2.4397376404336, 2.2628272057265346, 2.1067167587095983, 1.9836597394594475, 1.6663150066174761, 2.07544760727833, 2.3779477329255423, 2.1631559513931, 2.862675196272453},
			{3.1073304302880813, 3.842575678546945, 3.26665507247731, 2.73717203027656, 2.860109030864698, 2.329840233652109, 2.69459270600386, 3.4904230106586307, 2.862675196272453, 4.862031226519204},
		},
		[][]float64{
			{3.3365897720995465, 1.7966217500987922, 2.1702011544624584, 2.0833744624399664, 1.4085762923713823, 3.446474913760149, 1.9831168763457065, 3.106186774829319, 1.444329828911266, 2.4455719844142636},
			{1.7966217500987922, 1.540480714259107, 1.858998018359686, 1.3601091402084262, 1.3236100991669812, 2.4886271396341004, 1.3675133274244964, 1.9072089056418438, 1.0740765725415724, 1.8693746485791454},
			{2.1702011544624584, 1.858998018359686, 3.5445047413930966, 2.094584761283692, 1.807154270941748, 3.554034486119314, 1.9992415121786042, 2.6998240473567, 1.6958814573120122, 2.747660714929641},
			{2.0833744624399664, 1.3601091402084262, 2.094584761283692, 2.9949132572426764, 1.5129635142129767, 2.875284177512057, 2.1399926768358744, 2.3355575253921623, 1.2051807150126188, 2.5852750544061567},
			{1.4085762923713823, 1.3236100991669812, 1.807154270941748, 1.5129635142129767, 1.9591385294807941, 2.7736621121862264, 1.6257887095897428, 1.4514870741850794, 1.2728443136861443, 1.782762492128439},
			{3.446474913760149, 2.4886271396341004, 3.554034486119314, 2.875284177512057, 2.7736621121862264, 5.473185631107371, 2.55921012094091, 3.7589732234240523, 2.654484385653506, 3.671140964112938},
			{1.9831168763457065, 1.3675133274244964, 1.9992415121786042, 2.1399926768358744, 1.6257887095897428, 2.55921012094091, 2.3249506167058183, 1.9017324813549374, 1.1470240953799176, 2.5195438000680155},
			{3.106186774829319, 1.9072089056418438, 2.6998240473567, 2.3355575253921623, 1.4514870741850794, 3.7589732234240523, 1.9017324813549374, 3.4365059681338757, 1.748948408531831, 3.024356967252765},
			{1.444329828911266, 1.0740765725415724, 1.6958814573120122, 1.2051807150126188, 1.2728443136861443, 2.654484385653506, 1.1470240953799176, 1.748948408531831, 1.77772328131392, 1.9435324035048174},
			{2.4455719844142636, 1.8693746485791454, 2.747660714929641, 2.5852750544061567, 1.782762492128439, 3.671140964112938, 2.5195438000680155, 3.024356967252765, 1.9435324035048174, 4.120305547637426},
		},
		[][]float64{
			{2.4872915759398544, 2.5719693152318954, 2.9346811004551148, 2.502696740247222, 2.2573384412242454, 2.8236191011013774, 2.2251322092849755, 1.7074777697255263, 1.732961688181166, 2.177354555957213},
			{2.5719693152318954, 4.18497444247576, 3.5953082504172067, 3.9140006451857055, 3.154257140902123, 3.778485740588301, 3.221596166173665, 2.370489605427958, 1.8815802133960742, 3.121875463751378},
			{2.9346811004551148, 3.5953082504172067, 4.104046048432199, 3.648685295705109, 3.464130269133629, 4.011870398187577, 3.194061082174586, 2.422239718243278, 2.002483325887164, 3.164618946509936},
			{2.502696740247222, 3.9140006451857055, 3.648685295705109, 4.7156353167710945, 3.396630225893545, 4.38240403278282, 3.6820394755452535, 2.712263694592783, 1.89821005892966, 3.4916418066944677},
			{2.2573384412242454, 3.154257140902123, 3.464130269133629, 3.396630225893545, 3.9206131473306667, 3.6344348283836423, 2.7624864575796195, 2.3442911887222264, 1.840901190124226, 3.317176590187608},
			{2.8236191011013774, 3.778485740588301, 4.011870398187577, 4.38240403278282, 3.6344348283836423, 5.2514896945571214, 3.792705576594502, 2.3492724877783253, 2.3439139710971015, 3.707883353311444},
			{2.2251322092849755, 3.221596166173665, 3.194061082174586, 3.6820394755452535, 2.7624864575796195, 3.792705576594502, 3.3961876948849556, 2.135574787639643, 1.8911496349986063, 2.7879496239004964},
			{1.7074777697255263, 2.370489605427958, 2.422239718243278, 2.712263694592783, 2.3442911887222264, 2.3492724877783253, 2.135574787639643, 2.1167689845863706, 1.4941003690973438, 2.2412601138956867},
			{1.732961688181166, 1.8815802133960742, 2.002483325887164, 1.89821005892966, 1.840901190124226, 2.3439139710971015, 1.8911496349986063, 1.4941003690973438, 1.9473557397621268, 2.064636575408449},
			{2.177354555957213, 3.121875463751378, 3.164618946509936, 3.4916418066944677, 3.317176590187608, 3.707883353311444, 2.7879496239004964, 2.2412601138956867, 2.064636575408449, 3.595836943188528},
		},
		[][]float64{
			{2.9829021335110966, 2.3704943933232285, 1.9930282513941842, 1.5134671668409165, 2.3381401178240906, 2.5861032419822383, 1.8643728196450011, 1.8247848744971649, 2.283045709692646, 2.0465599208177756},
			{2.3704943933232285, 3.8575701697578695, 2.6782644863223757, 2.3877739227190404, 2.765962491216242, 3.186069225028565, 2.454583782896708, 2.4873588499584858, 2.047727293783791, 2.996431946285327},
			{1.9930282513941842, 2.6782644863223757, 3.1838165655036796, 1.8838308762035052, 3.0737019098408522, 2.2339942984481715, 2.7094240954595454, 2.144538052251288, 2.4252236206049247, 1.8010899108293459},
			{1.5134671668409165, 2.3877739227190404, 1.8838308762035052, 2.47871643074308, 2.0396834727408697, 1.653400603269274, 1.772526479282997, 1.3952914604841071, 1.7036664193162607, 1.8331566348590072},
			{2.3381401178240906, 2.765962491216242, 3.0737019098408522, 2.0396834727408697, 3.8988165312498175, 2.52063633958889, 2.84224827567818, 2.1544578016515925, 2.751628727125322, 1.926441417242371},
			{2.5861032419822383, 3.186069225028565, 2.2339942984481715, 1.653400603269274, 2.52063633958889, 3.849370243936654, 2.2830516359013693, 2.986446408284042, 2.497579595014817, 2.800933911632189},
			{1.8643728196450011, 2.454583782896708, 2.7094240954595454, 1.772526479282997, 2.84224827567818, 2.2830516359013693, 2.9413301246990247, 2.0481796627116697, 2.323342737211039, 2.199123974787113},
			{1.8247848744971649, 2.4873588499584858, 2.144538052251288, 1.3952914604841071, 2.1544578016515925, 2.986446408284042, 2.0481796627116697, 2.775243681862439, 2.2142569770887, 2.116985776661119},
			{2.283045709692646, 2.047727293783791, 2.4252236206049247, 1.7036664193162607, 2.751628727125322, 2.497579595014817, 2.323342737211039, 2.2142569770887, 2.7445547806630315, 1.6577873445107736},
			{2.0465599208177756, 2.996431946285327, 1.8010899108293459, 1.8331566348590072, 1.926441417242371, 2.800933911632189, 2.199123974787113, 2.116985776661119, 1.6577873445107736, 2.951062320793678},
		},
		[][]float64{
			{1.9686052444618345, 1.5633236766334815, 2.0231384323782358, 1.960249758057951, 1.9291213704824652, 1.26363903968882, 1.10725609622402, 2.3662482281823487, 2.216630224424894, 1.5852735643058387},
			{1.5633236766334815, 3.774782534462916, 2.9813396608476643, 3.3978772094345246, 2.29539731751937, 1.9829693459400635, 2.917055363049995, 2.4546410723400243, 2.441943524338501, 2.9539592860306505},
			{2.0231384323782358, 2.9813396608476643, 3.9762223513976944, 3.4964033449103, 1.7199130077931577, 2.3954052652680464, 2.1166176412893063, 2.936944647339579, 2.8109156687071057, 2.6670754955262015},
			{1.960249758057951, 3.3978772094345246, 3.4964033449103, 4.909756204050166, 2.511096522132693, 2.4650296444389292, 2.5850486277252136, 3.1745986152118877, 3.739189834949406, 3.7027084440501716},
			{1.9291213704824652, 2.29539731751937, 1.7199130077931577, 2.511096522132693, 3.068504636149034, 1.2416830150525675, 1.659386707698905, 2.896187530913171, 2.7099415701166683, 2.3780163645408092},
			{1.26363903968882, 1.9829693459400635, 2.3954052652680464, 2.4650296444389292, 1.2416830150525675, 1.747526870041049, 1.339494730786575, 1.7725249354831303, 1.8809310969995394, 1.9638066094052},
			{1.10725609622402, 2.917055363049995, 2.1166176412893063, 2.5850486277252136, 1.659386707698905, 1.339494730786575, 2.6664595373673854, 1.8070909003509097, 2.028183407390177, 2.2575155218680676},
			{2.3662482281823487, 2.4546410723400243, 2.936944647339579, 3.1745986152118877, 2.896187530913171, 1.7725249354831303, 1.8070909003509097, 4.18534249027117, 3.245686602458071, 2.24980761387379},
			{2.216630224424894, 2.441943524338501, 2.8109156687071057, 3.739189834949406, 2.7099415701166683, 1.8809310969995394, 2.028183407390177, 3.245686602458071, 3.7452346946150827, 2.947907159427524},
			{1.5852735643058387, 2.9539592860306505, 2.6670754955262015, 3.7027084440501716, 2.3780163645408092, 1.9638066094052, 2.2575155218680676, 2.24980761387379, 2.947907159427524, 3.542346743785778},
		},
		[][]float64{
			{1.0460988295359952, 1.4719958690838058, 1.135325964374474, 0.7762256004826921, 1.2377219631077432, 1.3955177525283637, 1.3710818447197075, 1.1583306848171733, 1.0471395638518137, 1.0614147120202186},
			{1.4719958690838058, 3.94885685135871, 2.923253103681284, 2.33374317228638, 2.419404736126368, 2.9286307296106306, 3.213444626360573, 2.4355127298582424, 2.4097248672663993, 1.875386578114877},
			{1.135325964374474, 2.923253103681284, 2.674553941248326, 2.050637119762515, 2.2015522718462583, 2.0960934418105195, 2.403144638333734, 1.6603302286615842, 1.838345331708812, 1.665987584161767},
			{0.7762256004826921, 2.33374317228638, 2.050637119762515, 2.4030053223283545, 1.9128270362911914, 2.403302813149741, 2.240186597566133, 1.7388571874287497, 1.7006754293433395, 1.8626971259845375},
			{1.2377219631077432, 2.419404736126368, 2.2015522718462583, 1.9128270362911914, 2.8271384614806063, 2.3760492117630374, 2.5309541406284746, 2.228231944169951, 2.066886140728349, 2.1305158043740455},
			{1.3955177525283637, 2.9286307296106306, 2.0960934418105195, 2.403302813149741, 2.3760492117630374, 3.4016707706496208, 2.9106798700914482, 2.520297056722334, 2.138497198333865, 2.2108615776964053},
			{1.3710818447197075, 3.213444626360573, 2.403144638333734, 2.240186597566133, 2.5309541406284746, 2.9106798700914482, 3.1425423216308355, 2.411171920760785, 2.1222158765193915, 2.1661947769317615},
			{1.1583306848171733, 2.4355127298582424, 1.6603302286615842, 1.7388571874287497, 2.228231944169951, 2.520297056722334, 2.411171920760785, 2.6017980899069975, 2.060609622024732, 1.8896292847904508},
			{1.0471395638518137, 2.4097248672663993, 1.838345331708812, 1.7006754293433395, 2.066886140728349, 2.138497198333865, 2.1222158765193915, 2.060609622024732, 2.3302395878442765, 1.6303040423151702},
			{1.0614147120202186, 1.875386578114877, 1.665987584161767, 1.8626971259845375, 2.1305158043740455, 2.2108615776964053, 2.1661947769317615, 1.8896292847904508, 1.6303040423151702, 2.1481760096818707},
		},
		[][]float64{
			{2.6394836919390867, 2.3451538725048917, 2.3804391767576827, 1.964876568659576, 2.5283261648616038, 1.264921008995065, 2.5661665245558263, 2.2272928461899615, 1.6497196278603412, 2.5708379296370762},
			{2.3451538725048917, 3.418127968091823, 3.2121701671896155, 2.3683942440274977, 3.4169864676693926, 2.1963266675684476, 2.8951549679078226, 2.7591223790227764, 2.1892374801096084, 2.903832171416303},
			{2.3804391767576827, 3.2121701671896155, 4.116654894404161, 2.555883971219931, 4.008022494994534, 2.4133077317451805, 3.147613168383031, 2.624062640158677, 2.318142889193453, 3.0135547481751934},
			{1.964876568659576, 2.3683942440274977, 2.555883971219931, 2.8229423140572463, 2.84163078945807, 1.9458903876813878, 2.897738325921029, 2.3743021252557464, 2.240540039989421, 2.061682517559019},
			{2.5283261648616038, 3.4169864676693926, 4.008022494994534, 2.84163078945807, 4.851051649120584, 2.7341680629857974, 3.7537668972948817, 3.049358934609985, 2.864114404237314, 3.4453103178488664},
			{1.264921008995065, 2.1963266675684476, 2.4133077317451805, 1.9458903876813878, 2.7341680629857974, 2.4547297193145767, 2.71684347574068, 1.9476702526258027, 1.8051910397982192, 1.8008276544776847},
			{2.5661665245558263, 2.8951549679078226, 3.147613168383031, 2.897738325921029, 3.7537668972948817, 2.71684347574068, 4.458319263577072, 3.090952449778036, 2.7363646484627067, 2.710715854429009},
			{2.2272928461899615, 2.7591223790227764, 2.624062640158677, 2.3743021252557464, 3.049358934609985, 1.9476702526258027, 3.090952449778036, 3.1739159130537296, 2.5590480654129837, 2.3611643301712633},
			{1.6497196278603412, 2.1892374801096084, 2.318142889193453, 2.240540039989421, 2.864114404237314, 1.8051910397982192, 2.7363646484627067, 2.5590480654129837, 2.3775503298906058, 1.9906311565248795},
			{2.5708379296370762, 2.903832171416303, 3.0135547481751934, 2.061682517559019, 3.4453103178488664, 1.8008276544776847, 2.710715854429009, 2.3611643301712633, 1.9906311565248795, 3.2488144898179883},
		},
		[][]float64{
			{2.496472220375692, 2.4421618995548102, 0.8366737028354913, 2.1213060893907314, 2.261023288564473, 2.70868212188346, 2.882447329347827, 2.131501027255537, 2.2599998998026773, 1.7078400597391843},
			{2.4421618995548102, 4.2663418621, 1.8677832901976597, 2.800405093479882, 2.814553785747158, 3.7482429624812204, 3.2523044514863915, 2.7445592023644694, 2.713163739910747, 3.2290949001853844},
			{0.8366737028354913, 1.8677832901976597, 1.346596031307915, 1.5660012540554606, 1.5220974449881601, 1.54564815157413, 1.48689077237076, 1.1019226902652308, 1.2570348533031686, 1.64032005684597},
			{2.1213060893907314, 2.800405093479882, 1.5660012540554606, 2.8342886129366875, 2.4441146892605135, 2.987464596045825, 3.2434413102016793, 2.3759656567755125, 2.2494258016659474, 2.2094483646059824},
			{2.261023288564473, 2.814553785747158, 1.5220974449881601, 2.4441146892605135, 2.9570686612428085, 2.500092985359626, 2.881077495951899, 1.983610685873534, 2.6378776350690125, 2.1325609161239543},
			{2.70868212188346, 3.7482429624812204, 1.54564815157413, 2.987464596045825, 2.500092985359626, 4.249987831475868, 3.7581580350190262, 3.1556792517623204, 2.2872329227801074, 2.808040515397561},
			{2.882447329347827, 3.2523044514863915, 1.48689077237076, 3.2434413102016793, 2.881077495951899, 3.7581580350190262, 4.413297969081735, 3.097014718995176, 2.559735271002427, 2.3718689720330848},
			{2.131501027255537, 2.7445592023644694, 1.1019226902652308, 2.3759656567755125, 1.983610685873534, 3.1556792517623204, 3.097014718995176, 2.6380329225926236, 2.0127063024179663, 2.1647356268663955},
			{2.2599998998026773, 2.713163739910747, 1.2570348533031686, 2.2494258016659474, 2.6378776350690125, 2.2872329227801074, 2.559735271002427, 2.0127063024179663, 3.0347744069500244, 2.0390692841667666},
			{1.7078400597391843, 3.2290949001853844, 1.64032005684597, 2.2094483646059824, 2.1325609161239543, 2.808040515397561, 2.3718689720330848, 2.1647356268663955, 2.0390692841667666, 3.221673791301034},
		},
		[][]float64{
			{3.795150406015799, 3.0277955336168643, 2.168391093952343, 2.6660034276574667, 1.8301364383770162, 2.198419408693736, 2.725042104289901, 1.6822564378398395, 2.3274498552110487, 2.3185739012931705},
			{3.0277955336168643, 3.2397646530475033, 3.0843564523254794, 2.8354128603363966, 1.9455178688437305, 2.1939881840368853, 3.2078510582394535, 2.3462247839312034, 2.2910850286469175, 2.7944151972328535},
			{2.168391093952343, 3.0843564523254794, 3.876858068186861, 2.964938279814767, 1.8368300428337876, 2.2092261202420875, 3.2173906372926995, 2.632737676582805, 2.4046992828613636, 3.090323908292247},
			{2.6660034276574667, 2.8354128603363966, 2.964938279814767, 3.860751254217817, 2.1475438188694316, 2.4889077756719944, 3.0415979942172555, 1.8217987978950314, 2.6324147971114944, 2.7355576550227214},
			{1.8301364383770162, 1.9455178688437305, 1.8368300428337876, 2.1475438188694316, 1.5968339101141282, 1.69779738387988, 1.7887768372599062, 1.287399071040989, 1.8781249705510863, 1.6711570818519044},
			{2.198419408693736, 2.1939881840368853, 2.2092261202420875, 2.4889077756719944, 1.69779738387988, 2.3454858786709596, 2.3170751804390033, 1.3953276056009158, 2.5508395527286605, 1.6508193570682803},
			{2.725042104289901, 3.2078510582394535, 3.2173906372926995, 3.0415979942172555, 1.7887768372599062, 2.3170751804390033, 4.119875576922299, 2.322720332387441, 2.4380643866120004, 2.787913783576561},
			{1.6822564378398395, 2.3462247839312034, 2.632737676582805, 1.8217987978950314, 1.287399071040989, 1.3953276056009158, 2.322720332387441, 2.616258768760187, 1.6283482778731886, 2.4325162545183923},
			{2.3274498552110487, 2.2910850286469175, 2.4046992828613636, 2.6324147971114944, 1.8781249705510863, 2.5508395527286605, 2.4380643866120004, 1.6283482778731886, 3.202953811489633, 1.9348062400173385},
			{2.3185739012931705, 2.7944151972328535, 3.090323908292247, 2.7355576550227214, 1.6711570818519044, 1.6508193570682803, 2.787913783576561, 2.4325162545183923, 1.9348062400173385, 3.29665900689103},
		},
		[][]float64{
			{3.0734458786852996, 2.5661912919608385, 2.6628841283318097, 3.255757420718687, 3.2397141954055964, 3.053806486951175, 2.9991953535090268, 3.174994548550873, 3.0782135188560744, 3.5576358301678725},
			{2.5661912919608385, 2.61407100147219, 2.2980094377845344, 2.5680561977734357, 2.8017354374265544, 2.6625824749071745, 2.5502804335173095, 2.732446640298581, 2.1035824931300247, 2.9284500124798045},
			{2.6628841283318097, 2.2980094377845344, 2.9554602860440276, 3.3219254443844126, 2.7135643046246485, 2.971816685674169, 2.75143615403621, 3.0001897366183536, 2.790849409962691, 3.173022557613135},
			{3.255757420718687, 2.5680561977734357, 3.3219254443844126, 4.268057942120797, 3.418800406052665, 3.515895607971125, 3.340893388201264, 3.531884223073061, 3.7793751614714175, 3.7922354277390773},
			{3.2397141954055964, 2.8017354374265544, 2.7135643046246485, 3.418800406052665, 4.261406083811678, 3.8854709372830487, 3.124816531035369, 3.8857576294807323, 3.696918431571872, 4.075677612603628},
			{3.053806486951175, 2.6625824749071745, 2.971816685674169, 3.515895607971125, 3.8854709372830487, 3.911752008449145, 2.92343977267412, 3.761114848970175, 3.414356709649742, 3.807604533153974},
			{2.9991953535090268, 2.5502804335173095, 2.75143615403621, 3.340893388201264, 3.124816531035369, 2.92343977267412, 4.023710078881581, 3.192323603060746, 3.876707139546848, 3.8604892565931466},
			{3.174994548550873, 2.732446640298581, 3.0001897366183536, 3.531884223073061, 3.8857576294807323, 3.761114848970175, 3.192323603060746, 3.8463915358286145, 3.6116588463993753, 4.053948800843824},
			{3.0782135188560744, 2.1035824931300247, 2.790849409962691, 3.7793751614714175, 3.696918431571872, 3.414356709649742, 3.876707139546848, 3.6116588463993753, 5.219677790955497, 4.340703715597781},
			{3.5576358301678725, 2.9284500124798045, 3.173022557613135, 3.7922354277390773, 4.075677612603628, 3.807604533153974, 3.8604892565931466, 4.053948800843824, 4.340703715597781, 4.684390282426366},
		},
	}
	// Randomly choose a matrix from the list
	matrixip := matrices[rand.Intn(len(matrices))]
	matrix.CholeskyFactorization(matrixip)
	fmt.Println("ACCEPTED")
}

// getClientLimiter retrieves or initializes a rate limiter for a given IP
func getClientLimiter(ip string) server.RateLimiter {
	clientsMu.Lock()
	defer clientsMu.Unlock()

	if client, exists := clients[ip]; exists {
		client.lastSeen = time.Now()
		return client.limiter
	}

	var limiter server.RateLimiter
	switch rateLimitAlgorithm {
	case "token_bucket":
		limiter = server.NewTokenBucket(burstLimit, time.Second/time.Duration(requestsPerSecond))
	case "leaky_bucket":
		limiter = server.NewLeakyBucket(burstLimit, time.Second/time.Duration(requestsPerSecond))
	case "sliding_window":
		limiter = server.NewSlidingWindow(requestsPerSecond, windowSize)
	case "fixed_window":
		limiter = server.NewFixedWindow(requestsPerSecond, windowSize)
	case "no_rate_limit":
		limiter = &server.NoRateLimiter{}
	default:
		log.Fatalf("Unknown rate limiting algorithm: %s", rateLimitAlgorithm)
	}

	clients[ip] = &Client{
		limiter:  limiter,
		lastSeen: time.Now(),
	}
	return limiter
}

// cleanupClients periodically removes clients that haven't been seen for a while
func cleanupClients() {
	for {
		time.Sleep(time.Minute)
		clientsMu.Lock()
		for ip, client := range clients {
			if time.Since(client.lastSeen) > 5*time.Minute {
				delete(clients, ip)
			}
		}
		clientsMu.Unlock()
	}
}

func main() {
	flag.StringVar(&rateLimitAlgorithm, "algorithm", "token_bucket", "Rate limiting algorithm to use")
	flag.IntVar(&requestsPerSecond, "rate", 10, "Number of requests per second")
	flag.IntVar(&burstLimit, "burst", 5, "Burst limit for the rate limiter")
	flag.DurationVar(&windowSize, "window", time.Second, "Window size for window-based algorithms")
	flag.Parse()

	go cleanupClients()

	go func() {
		for {
			time.Sleep(time.Minute)
			requestCountMu.Lock()
			log.Printf("Total accepted requests: %d, Total denied requests: %d, Non-200 responses: %d", acceptedCount, deniedCount, non200Count)
			requestCountMu.Unlock()
		}
	}()

	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		ip := extractIP(r)
		limiter := getClientLimiter(ip)

		if !limiter.Allow() {
			requestCountMu.Lock()
			deniedCount++
			non200Count++
			requestCountMu.Unlock()

			w.WriteHeader(http.StatusTooManyRequests)
			log.Printf("[%s] Response sent: Status %d, IP %s", time.Now().Format("2006-01-02 15:04:05"), http.StatusTooManyRequests, ip)
			fmt.Fprint(w, "Rate limit exceeded")
			return
		}

		requestCountMu.Lock()
		acceptedCount++
		requestCountMu.Unlock()

		w.WriteHeader(http.StatusOK)
		log.Printf("[%s] Response sent: Status %d, IP %s", time.Now().Format("2006-01-02 15:04:05"), http.StatusOK, ip)
		fmt.Fprint(w, "Hello from the Go server!")
	})

	fmt.Println("Rate-limiting server running on http://0.0.0.0:80")
	log.Fatal(http.ListenAndServe("0.0.0.0:80", nil))
}

// extractIP extracts the IP address from the request's RemoteAddr
func extractIP(r *http.Request) string {
	ipPort := r.RemoteAddr
	ip := ipPort
	if strings.Contains(ipPort, ":") {
		if strings.Count(ipPort, ":") > 1 {
			ip = strings.Trim(ipPort, "[]")
			colon := strings.LastIndex(ip, ":")
			if colon != -1 {
				ip = ip[:colon]
			}
		} else {
			ip, _, _ = net.SplitHostPort(ipPort)
		}
	}
	return ip
}
